var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a]);i.prototype=e.prototype,t.prototype=new i},__awaiter=this&&this.__awaiter||function(t,e,i,a){return new(i||(i=Promise))(function(s,n){function r(t){try{o(a.next(t))}catch(e){n(e)}}function h(t){try{o(a["throw"](t))}catch(e){n(e)}}function o(t){t.done?s(t.value):new i(function(e){e(t.value)}).then(r,h)}o((a=a.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return a([t,e])}}function a(i){if(s)throw new TypeError("Generator is already executing.");for(;o;)try{if(s=1,n&&(r=n[2&i[0]?"return":i[0]?"throw":"next"])&&!(r=r.call(n,i[1])).done)return r;switch(n=0,r&&(i=[0,r.value]),i[0]){case 0:case 1:r=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,n=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(r=o.trys,!(r=r.length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){o.label=i[1];break}if(6===i[0]&&o.label<r[1]){o.label=r[1],r=i;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(i);break}r[2]&&o.ops.pop(),o.trys.pop();continue}i=e.call(t,o)}catch(a){i=[6,a],n=0}finally{s=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var s,n,r,h,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return h={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(h[Symbol.iterator]=function(){return this}),h},enemy;!function(t){var e=function(t){function e(e,i,a,s){var n=t.call(this)||this;return n.hp=18,n.v=2,n.dir=1,n.enemy_name=e,n.h=i,n.w=a,n.tmxLayer=s,n.addEventListener(egret.Event.ADDED_TO_STAGE,n.onAddToStage,n),n}return __extends(e,t),e.prototype.onAddToStage=function(t){var e=RES.getRes("enemies_json"),i=RES.getRes("enemies_png");this.mcFactory=new egret.MovieClipDataFactory(e,i),this.mc_c=new egret.MovieClip(this.mcFactory.generateMovieClipData(this.enemy_name)),this.addChild(this.mc_c),this.mc_c.gotoAndPlay("idle",-1),this.state="walk",this.dir=-1},e.prototype.updata=function(){this.roadTest(),this.x+=this.v*this.dir,this.v<2&&(this.v+=.2)},e.prototype.changeState=function(){"walk"==this.state&&(this.dir<0?this.mc_c.anchorOffsetX+=this.w:this.mc_c.anchorOffsetX-=this.w,this.dir*=-1,this.mc_c.skewY=(this.mc_c.skewY+180)%360)},e.prototype.attacked=function(){this.v=-1},e.prototype._die=function(){this.mc_c.gotoAndPlay("die",1),this.mc_c.addEventListener(egret.Event.COMPLETE,function(){this.parent.removeChild(this)},this)},e.prototype.roadTest=function(){if(-1==this.dir){var t=this.x-20,e=this.y+this.h+10,i=this.tmxLayer.getTile(t,e);null==i&&this.changeState(),e=this.y+this.h/2,i=this.tmxLayer.getTile(t,e),null!=i&&this.changeState()}else{var t=this.x+this.w+20,e=this.y+this.h+10,i=this.tmxLayer.getTile(t,e);null==i&&this.changeState(),e=this.y+this.h/2,i=this.tmxLayer.getTile(t,e),null!=i&&this.changeState()}},e}(egret.DisplayObjectContainer);t.Enemy=e,__reflect(e.prototype,"enemy.Enemy")}(enemy||(enemy={}));var ui;!function(t){var e=function(t){function e(e,i){var a=t.call(this)||this;return a.addEventListener(egret.Event.ADDED_TO_STAGE,a.onAddToStage,a),a.bar1=new egret.Bitmap,a.bar2=new egret.Bitmap,a.bar1.texture=e,a.bar2.texture=i,a}return __extends(e,t),e.prototype.onAddToStage=function(t){this.addChild(this.bar1),this.addChild(this.bar2),this.mask_shp=new egret.Rectangle(0,0,0,200)},e.prototype.updata=function(t,e){this.mask_shp.width=this.bar1.width*t/e,this.bar2.mask=this.mask_shp,console.log(this.bar2.mask.width+"========"+this.bar2.mask)},e}(egret.DisplayObjectContainer);t.bar=e,__reflect(e.prototype,"ui.bar")}(ui||(ui={}));var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return[4,this.loadResource()];case 1:return i.sent(),this.createGameScene(),[4,RES.getResAsync("description_json")];case 2:return t=i.sent(),this.startAnimation(t),[4,platform.login()];case 3:return i.sent(),[4,platform.getUserInfo()];case 4:return e=i.sent(),console.log(e),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return i.sent(),[4,RES.loadGroup("preload",0,t)];case 2:return i.sent(),this.stage.removeChild(t),[3,4];case 3:return e=i.sent(),console.error(e),[3,4];case 4:return[2]}})})},e.prototype.start=function(){var t=new egret.Sound;t.addEventListener(egret.Event.COMPLETE,function(e){t.play().volume=.4},this),t.addEventListener(egret.IOErrorEvent.IO_ERROR,function(t){console.log("loaded error!")},this),t.load("resource/assets/bgm1.mp3"),this.timer=new egret.Timer(30),this.timer.start(),this.misaka=new game.Misaka,this.map=new game.Map(this.misaka),this.misaka.map=this.map,this.map.scaleY=.7,this.map.scaleX=.7,this.addChild(this.map),this.timer.addEventListener(egret.TimerEvent.TIMER,this.updata,this)},e.prototype.createGameScene=function(){var t=new egret.Sound;t.addEventListener(egret.Event.COMPLETE,function(e){this.bgm=t.play(),this.bgm.volume=.4},this),t.load("resource/assets/lv5.mp3");var e=new egret.Bitmap;e.texture=RES.getRes("timg_jpg"),e.x-=100,e.width=this.stage.stageWidth+150,e.height=this.stage.stageHeight,this.addChild(e);var i=new egret.Bitmap;i.texture=RES.getRes("st_jpg"),i.y=this.stage.stageHeight-100,i.height=70,i.width=200,i.x=30,this.addChild(i),i.touchEnabled=!0,i.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){this.removeChild(i),this.removeChild(e),this.bgm.stop(),this.start()},this)},e.prototype.updata=function(t){this.map.updata(),this.misaka.updata()},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.startAnimation=function(t){var e=this,i=new egret.HtmlTextParser,a=t.map(function(t){return i.parse(t)}),s=this.textfield,n=-1,r=function(){n++,n>=a.length&&(n=0);var t=a[n];s.textFlow=t;var i=egret.Tween.get(s);i.to({alpha:1},200),i.wait(2e3),i.to({alpha:0},200),i.call(r,e)};r()},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var enemy;!function(t){var e=function(t){function e(e){var i=t.call(this,"SlimeBlack",70,70,e)||this;return i.scaleX=.5,i.scaleY=.5,i}return __extends(e,t),e}(t.Enemy);t.SlimeBlack=e,__reflect(e.prototype,"enemy.SlimeBlack")}(enemy||(enemy={}));var game;!function(t){var e=function(t){function e(e){var i=t.call(this)||this;return i.f=!1,i.f2=!1,i.misaka=e,i.addEventListener(egret.Event.ADDED_TO_STAGE,i.onAddToStage,i),i}return __extends(e,t),e.prototype.onAddToStage=function(t){this.url="resource/assets/yubangamemap.tmx",this.request=new egret.HttpRequest,this.request.once(egret.Event.COMPLETE,this.onMapComplete,this),this.request.open(this.url,egret.HttpMethod.GET),this.request.send()},e.prototype.onMapComplete=function(t){var e=egret.XML.parse(t.currentTarget.response);this.tmxTileMap=new tiled.TMXTilemap(3200,640,e,this.url),this.tmxTileMap.render(),this.addChild(this.tmxTileMap),this.tmxTileMap.touchEnabled=!0,this.tmxTileMap.addEventListener(tiled.TMXImageLoadEvent.ALL_IMAGE_COMPLETE,this.onAllImageComplete,this),this.hpbar=new ui.hp,this.addChild(this.hpbar),this._bg=new egret.Bitmap,this._bg.texture=RES.getRes("bg_png"),this._bg.scaleX=1.6,this._bg.scaleY=.75,this.stage.addChildAt(this._bg,0)},e.prototype.createEnemy=function(){this.enemies_list=new Array;for(var t=this.tmxObjectGroup.getObjectCount(),e=0;t>e;e++){var i=this.tmxObjectGroup.getObjectByIndex(e);if(null!=i&&i.id>5&&16!=i.id){var a=new enemy.SlimeBlack(this.tmxLayer);this.enemies_list.push(a),a.x=i.x-a.w/2,a.y=i.y-a.h,this.addChild(a)}}this.f2=!0},e.prototype.onAllImageComplete=function(t){var e=this.tmxTileMap.getObjects();this.tmxObjectGroup=e[0];var i=e[0].getObjectById(5);null!=i&&(this.misaka.x=i.x,this.misaka.y=i.y-this.misaka.h,this.addChild(this.misaka)),this.tmxLayer=this.tmxTileMap.getLayers()[0],this.createEnemy(),this.f=!0},e.prototype.updata=function(){this.misaka.x<10&&(this.misaka.x=10),this.misaka.x>3e3&&(this.misaka.x=3e3),this.misaka.mp<100&&(this.misaka.mp+=.3),console.log(this,this.hpbar),this.hpbar.updata(this.misaka.mp,100);var t=this.stage.stageWidth/2;if(this.misaka.y>this.stage.stageHeight&&(this.misaka.y=0,this.misaka.x=100,this.x=0),this.misaka.x-this.x>t&&this.misaka.x<3200-t&&(this.x=.7*-(this.misaka.x-t),this.hpbar.x=this.misaka.x-t+50),this.f&&this.hitTest(this.misaka),this.f&&this.f2)for(var e=this.enemies_list.length,i=0;e>i;i++){var a=this.enemies_list[i];a.updata(),a.hp<0&&(a._die(),this.enemies_list.splice(i,1),i--,e--)}this.f&&this.f2&&this.enemyHitTest()},e.prototype.enemyHitTest=function(){for(var t=this.enemies_list.length,e=0;t>e;e++){var i=this.enemies_list[e],a=this.misaka.getBounds(),s=i.getBounds();a.x=this.misaka.x+20,a.y=this.misaka.y,a.width=5,s.x=i.x,s.y=i.y+i.h/2,s.width=i.w/2,s.height=i.h/2,a.intersects(s)&&(console.log("被怪物揍了TAT"),this.misaka.hp-=10,this.misaka.x<i.x?(this.misaka.back=-4,this.misaka.back_a=.6):(this.misaka.back=4,this.misaka.back_a=-.6))}},e.prototype.attackTest=function(t){for(var e=this.enemies_list.length,i=0;e>i;i++){var a=this.enemies_list[i],s=new egret.Rectangle,n=a.getBounds();s.width=300,s.height=20,n.width=a.w/2,"attack_r"==this.misaka.state?s.x=this.misaka.x:s.x=this.misaka.x-320,s.y=this.misaka.y+50,n.x=a.x-20,n.y=a.y,s.intersects(n)&&(a.hp-=10,a.attacked())}},e.prototype.hitTest=function(t){var e=t.x+t.w/2,i=t.y+t.h+5,a=this.tmxLayer.getTile(e,i);null!=a?(t.y=32*a.tileY-t.h,t.vy>0&&(t.ay=0,t.vy=0,0==t.fx?"jump_r"==t.state?t.changeState("idle_r"):t.changeState("idle_l"):1==t.fx?t.changeState("run_r"):t.changeState("run_l"))):t.ay=2,e=t.x+t.w,i=t.y+t.h/2,a=this.tmxLayer.getTile(e,i),null==a||"run_r"!=t.state&&"jump_r"!=t.state||(t.ffx=0),e=t.x,i=t.y+t.h/2,a=this.tmxLayer.getTile(e,i),null==a||"run_l"!=t.state&&"jump_l"!=t.state||(t.ffx=0),e=t.x+t.w/2,i=t.y-5,a=this.tmxLayer.getTile(e,i),null==a||"jump_r"!=t.state&&"jump_l"!=t.state||(t.vy=0)},e}(egret.DisplayObjectContainer);t.Map=e,__reflect(e.prototype,"game.Map")}(game||(game={}));var game;!function(t){var e=function(t){function e(){var e=t.call(this)||this;return e.mp=10,e.vx=10,e.vy=0,e.ffx=1,e.ffy=1,e.h=78,e.w=70,e.ay=2,e.back=0,e.back_a=.6,e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){var e=RES.getRes("misaka_json"),i=RES.getRes("misaka_png");this.mcFactory=new egret.MovieClipDataFactory(e,i),this.mc_c=new egret.MovieClip(this.mcFactory.generateMovieClipData("character")),this.mc_a=new egret.MovieClip(this.mcFactory.generateMovieClipData("effect")),this.mc_a.y=-18,this.mc_a.x=26,this.addChild(this.mc_c),this.sound_railgun=new egret.Sound,this.sound_coin=new egret.Sound,this.sound_o=new egret.Sound,this.sound_run=new egret.Sound,this.sound_jump=new egret.Sound,this.sound_railgun.load("resource/assets/railgun.mp3"),this.sound_coin.load("resource/assets/coin.mp3"),this.sound_o.load("resource/assets/o.mp3"),this.sound_run.load("resource/assets/run.mp3"),this.sound_jump.load("resource/assets/jump.mp3");var a=new egret.Sound;a.addEventListener(egret.Event.COMPLETE,function(t){a.play(0,1)},this),a.load("resource/assets/chushou.mp3"),this.kb=new KeyBoard,this.kb.addEventListener(KeyBoard.onkeyup,this.onkeyup,this),this.kb.addEventListener(KeyBoard.onkeydown,this.onkeydown,this),this.state="idle_r",this.fx=0,this.fy=0,this.scaleY=.8,this.scaleX=.8,this.mc_c.gotoAndPlay(this.state,-1)},e.prototype.onkeydown=function(t){this.kb.isContain(t.data,KeyBoard.W)&&"jump_l"!=this.state&&"jump_r"!=this.state&&(this.kb.isContain(t.data,KeyBoard.A)&&this.kb.isContain(t.data,KeyBoard.D)?(this.fx>0?this.changeState("jump_r"):this.fx<0&&this.changeState("jump_l"),this.fx=0):this.kb.isContain(t.data,KeyBoard.D)?(this.fx=1,this.changeState("jump_r")):this.kb.isContain(t.data,KeyBoard.A)?(this.fx=-1,this.changeState("jump_l")):"idle_l"==this.state?this.changeState("jump_l"):this.changeState("jump_r"),this.sound_jump.play(0,1).volume=.5),0==this.vy&&"attack_l"!=this.state&&"attack_r"!=this.state&&(this.mp>20&&this.kb.isContain(t.data,KeyBoard.A)&&this.kb.isContain(t.data,KeyBoard.J)?this.changeState("attack_l"):this.mp>20&&this.kb.isContain(t.data,KeyBoard.D)&&this.kb.isContain(t.data,KeyBoard.J)?this.changeState("attack_r"):this.mp>20&&this.kb.isContain(t.data,KeyBoard.J)?"idle_l"==this.state?this.changeState("attack_l"):this.changeState("attack_r"):"attack_l"!=this.state&&"attack_r"!=this.state&&(this.kb.isContain(t.data,KeyBoard.A)&&this.kb.isContain(t.data,KeyBoard.D)?(this.fx>0?this.changeState("idle_r"):this.fx<0&&this.changeState("idle_l"),this.fx=0):this.kb.isContain(t.data,KeyBoard.D)?(this.fx=1,this.changeState("run_r")):this.kb.isContain(t.data,KeyBoard.A)&&(this.fx=-1,this.changeState("run_l"))))},e.prototype.onkeyup=function(t){"attack_l"!=this.state&&"attack_r"!=this.state?0==this.vy?this.kb.isContain(t.data,KeyBoard.A)&&this.kb.isContain(t.data,KeyBoard.D)?this.fx=0:this.kb.isContain(t.data,KeyBoard.D)?(this.fx=1,this.changeState("run_r")):this.kb.isContain(t.data,KeyBoard.A)?(this.fx=-1,this.changeState("run_l")):(this.fx>0?this.changeState("idle_r"):this.fx<0&&this.changeState("idle_l"),this.fx=0):this.kb.isContain(t.data,KeyBoard.A)&&this.kb.isContain(t.data,KeyBoard.D)?this.fx=0:this.kb.isContain(t.data,KeyBoard.D)?this.fx=1:this.kb.isContain(t.data,KeyBoard.A)?this.fx=-1:this.fx=0:this.kb.isContain(t.data,KeyBoard.A)&&this.kb.isContain(t.data,KeyBoard.D)?(this.pre_fx=0,"attack_l"==this.state?this.pre_state="idle_l":this.pre_state="idle_r"):this.kb.isContain(t.data,KeyBoard.D)?(this.pre_fx=1,this.pre_state="run_r"):this.kb.isContain(t.data,KeyBoard.A)?(this.pre_fx=-1,this.pre_state="run_l"):(this.pre_fx=0,"attack_l"==this.state?this.pre_state="idle_l":this.pre_state="idle_r")},e.prototype.attackComplete=function(t){this.removeChild(this.mc_a),this.mc_c.removeEventListener(egret.Event.COMPLETE,this.attackComplete,this),this.fx=this.pre_fx,this.changeState(this.pre_state),this.mc_c.anchorOffsetX=0,this.mc_a.y=-18,this.mc_a.x=26},e.prototype.updata=function(){this.back_a>0&&this.back<0?(this.x+=this.back,this.back+=this.back_a):this.back_a<0&&this.back>0&&(this.x+=this.back,this.back+=this.back_a),this.x+=this.vx*this.fx*this.ffx,this.vy<10&&(this.vy+=this.ay),this.y+=this.vy,this.ffx=1,this.ffy=1},e.prototype.changeState=function(t){switch(this.pre_state=this.state,this.pre_fx=this.fx,this.state!=t&&(this.state=t,this.mc_c.gotoAndPlay(this.state,-1)),t){case"jump_l":case"jump_r":this.vy=-15;break;case"run_l":break;case"run_r":break;case"attack_l":this.fx=0,this.mc_c.anchorOffsetX=44,this.sound_coin.play(0,1),this.mc_c.gotoAndPlay("attack_l",1),this.mc_c.addEventListener(egret.Event.COMPLETE,this.attackComplete,this),this.mc_c.addEventListener(egret.MovieClipEvent.FRAME_LABEL,this.onok1,this),this.mp-=20;break;case"attack_r":this.fx=0,this.sound_coin.play(0,1),this.mc_c.gotoAndPlay("attack_r",1),this.mc_c.addEventListener(egret.Event.COMPLETE,this.attackComplete,this),this.mc_c.addEventListener(egret.MovieClipEvent.FRAME_LABEL,this.onok1,this),this.mp-=20}},e.prototype.onok1=function(t){this.mc_a.removeEventListener(egret.MovieClipEvent.FRAME_LABEL,this.onok1,this),"@ok1"==t.frameLabel?(this.sound_railgun.play(0,1),this.mc_a.x=-500,this.mc_a.gotoAndPlay("railgun_l",3),this.addChild(this.mc_a),this.map.attackTest(-1)):(this.sound_railgun.play(0,1),this.mc_a.gotoAndPlay("railgun_r",3),this.addChild(this.mc_a),this.map.attackTest(1))},e}(egret.DisplayObjectContainer);t.Misaka=e,__reflect(e.prototype,"game.Misaka")}(game||(game={}));var ui;!function(t){var e=function(t){function e(){var e=this,i=RES.getRes("mp1_png"),a=RES.getRes("mp0_png");return e=t.call(this,i,a)||this,e.x=50,e.y=100,e}return __extends(e,t),e}(t.bar);t.hp=e,__reflect(e.prototype,"ui.hp")}(ui||(ui={}));var utils;!function(t){var e=function(){function t(){}return t.hitTest=function(t,e){var i=t.getBounds(),a=e.getBounds(),s=t.localToGlobal(t.x,t.y),n=e.localToGlobal(e.x,e.y);return i.height=100,i.width=320,i.x=s.x+300,i.y=s.y+100,a.x=n.x,a.y=n.y,console.log(i+" and "+a),i.intersects(a)},t}();t.GameUtil=e,__reflect(e.prototype,"utils.GameUtil")}(utils||(utils={}));